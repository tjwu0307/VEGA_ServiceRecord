<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>服務記錄表填寫</title>

  <!-- 先載入外掛：SignaturePad → html2canvas → html2pdf -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <style>
    body{font-family:"Noto Sans TC","Microsoft JhengHei",sans-serif;color:#111;background:#fff;margin:0}
    #service-form{width:190mm;max-width:100%;margin:12mm auto;padding:8mm;box-sizing:border-box;background:#fff}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border:1px solid #999;padding:4px;vertical-align:top;word-break:break-word}
    th{background:#f5f5f5;white-space:nowrap;text-align:left}
    .actions{text-align:center;margin:12px 0}
    .btn{border:1px solid #444;background:#FF5151;color:#fff;padding:6px 20px;font-size:14px;cursor:pointer;border-radius:3px}
    .btn:hover{background:#e04848}
    .no-pdf{display:inline-block}
    @media print{ .no-pdf{ display:none !important; } }
    .sig-wrap{display:flex;gap:12px;align-items:center}
    .sig-box{border:1px solid #999;height:130px}
    .sig-box canvas{width:100%;height:100%}
    .sig-clear{margin-top:6px}
  </style>
</head>

<body>
<form id="service-form">
  <header class="form-header" style="margin-bottom:8px;">
    <div style="display:flex;align-items:flex-start;gap:12px">
      <!-- 可改為 /VEGAbase64LOGO.txt；程式會自動嘗試載入 -->
      <img id="company-logo" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA..." style="height:60px;margin-right:12px" alt="公司Logo"/>
      <div class="company-info" style="flex:1">
        <div class="company-name">維嘉全球科技股份有限公司</div>
        <div style="display:flex;gap:32px">
          <div class="branch">北區<br>免付費專線:0800-521-800<br>Tel:(02)3518-2883<br>Fax:(02)2545-1155</div>
          <div class="branch">中區<br>台中市北區文心路四段81號9樓之2<br>Tel:(04)2295-8966<br>Fax:(04)2295-5833</div>
          <div class="branch">南區<br>高雄市新興區中山二路91號8樓之9<br>Tel:(07)333-0099<br>Fax:(07)535-0099</div>
        </div>
      </div>
    </div>
  </header>

  <!-- ✦✦✦ 你的表格：維持原格式（欄寬等不要動） ✦✦✦ -->
  <table>
    <tr>
      <th style="width:16%;">專案代號</th>
      <td style="width:34%;"><input id="projectCode" type="text" style="width:100%"></td>
      <th style="width:16%;">叫修單號</th>
      <td style="width:34%;"><input id="ticketNo" type="text" style="width:100%"></td>
    </tr>
    <tr>
      <th>客戶名稱</th>
      <td><input id="customerName" type="text" style="width:100%"></td>
      <th>聯絡人</th>
      <td><input id="contact" type="text" style="width:100%"></td>
    </tr>
    <tr>
      <th>地址</th>
      <td><input id="address" type="text" style="width:100%"></td>
      <th>電話</th>
      <td><input id="phone" type="text" style="width:100%"></td>
    </tr>

    <!-- 日期 + 時段（同一列） -->
    <tr>
      <th>服務日期（民國）</th>
      <td>
        <input id="roc_y" type="number" placeholder="年" style="width:50px"> 年
        <input id="roc_m" type="number" placeholder="月" style="width:40px"> 月
        <input id="roc_d" type="number" placeholder="日" style="width:40px"> 日
      </td>
      <th>到達時間</th>
      <td><input id="arriveTxt" type="text" style="width:100%"></td>
    </tr>
    <tr>
      <th>工程師</th>
      <td><input id="engineer" type="text" style="width:100%"></td>
      <th>結束時間</th>
      <td><input id="finishTxt" type="text" style="width:100%"></td>
    </tr>

    <tr>
      <th>服務方式</th>
      <td colspan="3">
        <label><input type="checkbox" name="serviceMethod" value="到場"> 到場</label>
        <label style="margin-left:12px"><input type="checkbox" name="serviceMethod" value="遠端"> 遠端</label>
        <label style="margin-left:12px"><input type="checkbox" name="serviceMethod" value="電話"> 電話</label>
        <label style="margin-left:12px"><input type="checkbox" name="serviceMethod" value="返廠"> 返廠</label>
      </td>
    </tr>

    <tr>
      <th>服務產品</th>
      <td colspan="3">
        <textarea id="products" rows="2" style="width:100%" placeholder="品牌/型號/版本/序號… 逐項一行"></textarea>
      </td>
    </tr>
    <tr>
      <th>服務內容</th>
      <td colspan="3"><textarea id="serviceContent" rows="3" style="width:100%"></textarea></td>
    </tr>
    <tr>
      <th>客戶回饋</th>
      <td colspan="3"><textarea id="customerFeedback" rows="2" style="width:100%"></textarea></td>
    </tr>

    <!-- 簽名區 -->
    <tr>
      <th>直屬主管簽名</th>
      <td class="sig-wrap">
        <div style="flex:1">
          <div class="sig-box"><canvas id="pad-manager"></canvas></div>
          <button type="button" class="no-pdf sig-clear" onclick="clearSignature('manager')">清除</button>
        </div>
      </td>
      <th>工程師簽名</th>
      <td class="sig-wrap">
        <div style="flex:1">
          <div class="sig-box"><canvas id="pad-engineer"></canvas></div>
          <button type="button" class="no-pdf sig-clear" onclick="clearSignature('engineer')">清除</button>
        </div>
      </td>
    </tr>
    <tr>
      <th>客戶簽名</th>
      <td colspan="3" class="sig-wrap">
        <div style="flex:1">
          <div class="sig-box"><canvas id="pad-customer"></canvas></div>
          <button type="button" class="no-pdf sig-clear" onclick="clearSignature('customer')">清除</button>
        </div>
      </td>
    </tr>

    <tr>
      <th>寄送 Email (可選)</th>
      <td colspan="3">
        <input id="sendTo" type="email" placeholder="收件者 Email (若不寄送可留空)" style="width:60%">
      </td>
    </tr>
  </table>

  <div class="actions">
    <button type="button" id="btn-print" class="btn no-pdf" onclick="downloadPDF()">列印 / PDF</button>
    <button type="button" id="btn-send" class="btn no-pdf" onclick="submitForm()">發送(Email/雲端/寫回)</button>
  </div>
</form>

<script>
/* ================= 基本設定 ================= */
const WEBAPP_URL =
  'https://script.google.com/macros/s/AKfycby4p_ZHHAki_TeBDZyTHyD_T4Hef7uTzl65stE6gy3uDn3WcY0EF4Q7wne1XGYBnJB_LA/exec';

/* 嘗試由 /VEGAbase64LOGO.txt 載入 logo（若不存在就忽略） */
(function loadTxtLogo(){
  fetch('VEGAbase64LOGO.txt').then(r=>r.ok?r.text():Promise.reject())
    .then(txt=>{
      const s = (txt||'').trim();
      if (s.startsWith('data:image/')) document.getElementById('company-logo').src = s;
    }).catch(()=>{});
})();

/* =============== 簽名板初始化 =============== */
let pads = {};
function resizeCanvas(canvas){
  const ratio = Math.max(window.devicePixelRatio || 1, 1);
  const rect = canvas.getBoundingClientRect();
  canvas.width  = Math.round(rect.width*ratio);
  canvas.height = Math.round(rect.height*ratio);
  const ctx = canvas.getContext('2d');
  ctx.scale(ratio, ratio);
}
function initPads(){
  ['manager','engineer','customer'].forEach(id=>{
    const canvas = document.getElementById('pad-'+id);
    resizeCanvas(canvas);
    pads[id] = new SignaturePad(canvas, {backgroundColor:'rgba(255,255,255,0)'});
  });
}
window.addEventListener('resize', ()=>{
  Object.entries(pads).forEach(([id, pad])=>{
    const canvas = document.getElementById('pad-'+id);
    const data = pad.toData();       // 保留內容
    resizeCanvas(canvas);
    pad.clear();
    pad.fromData(data);
  });
});
function clearSignature(who){
  if (pads[who]) pads[who].clear();
}
window.clearSignature = clearSignature;

/* =============== 讀值 =============== */
function collectServiceMethods(){
  return Array.from(document.querySelectorAll('input[name="serviceMethod"]:checked'))
              .map(el=>el.value);
}
function collectFormData(){
  const g = id => document.getElementById(id)?.value?.trim() || '';
  const rocY = g('roc_y'), rocM = g('roc_m'), rocD = g('roc_d');
  const serviceDate = (rocY||rocM||rocD) ? `民國${rocY}年${rocM}月${rocD}日` : '';

  return {
    timestamp: new Date(),
    projectCode: g('projectCode'),
    ticketNo: g('ticketNo'),
    customerName: g('customerName'),
    address: g('address'),
    contact: g('contact'),
    phone: g('phone'),
    engineer: g('engineer'),
    rocY, rocM, rocD,
    arriveTxt: g('arriveTxt'),
    finishTxt: g('finishTxt'),
    serviceDate,
    serviceMethods: collectServiceMethods(),
    products: g('products'),
    serviceContent: g('serviceContent'),
    customerFeedback: g('customerFeedback')
  };
}
function collectSignatures(){
  return {
    manager:  pads.manager  && !pads.manager.isEmpty()  ? pads.manager.toDataURL()  : '',
    engineer: pads.engineer && !pads.engineer.isEmpty() ? pads.engineer.toDataURL() : '',
    customer: pads.customer && !pads.customer.isEmpty() ? pads.customer.toDataURL() : ''
  };
}

/* =============== PDF 產生 =============== */
function buildPrintableNode(data, sigs){
  // 複製整個表單成「乾淨節點」用於輸出 PDF
  const src = document.getElementById('service-form');
  const node = src.cloneNode(true);

  // 將所有 <input>/<textarea>/<checkbox> 轉成純文字，避免 PDF 顯示為空白控件
  node.querySelectorAll('input, textarea').forEach(el=>{
    const td = document.createElement('div');
    td.style.minHeight = (el.tagName==='TEXTAREA' ? '36px' : 'auto');
    td.textContent = el.type==='checkbox'
      ? (el.checked ? '■ ' + (el.value||'') : '')
      : el.value || '';
    el.replaceWith(td);
  });
  // 把 no-pdf 的按鈕去掉
  node.querySelectorAll('.no-pdf').forEach(el=>el.remove());

  // 簽名 canvas 換成 <img>
  const setImg = (id, dataUrl) => {
    const c = node.querySelector('#pad-'+id);
    if (!c) return;
    const wrap = c.parentElement;
    const img = document.createElement('img');
    img.style.maxWidth='100%'; img.style.height='120px';
    if (dataUrl) img.src = dataUrl;
    wrap.innerHTML=''; wrap.appendChild(img);
  };
  setImg('manager',  sigs.manager);
  setImg('engineer', sigs.engineer);
  setImg('customer', sigs.customer);

  return node;
}
async function createPdf(formData, signatures){
  const el = buildPrintableNode(formData, signatures);
  const fileName = `服務記錄_${formData.customerName||''}_${formData.rocY||''}${formData.rocM||''}${formData.rocD||''}.pdf`;

  const opt = {
    margin:       [10,10,10,10],
    filename:     fileName,
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, useCORS:true, allowTaint:true },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };

  // 1) 下載/列印用
  const worker = html2pdf().set(opt).from(el);
  // 2) 產出 base64 給後端
  const pdfBase64 = await html2pdf().set(opt).from(el).outputPdf('datauristring');
  return { worker, pdfBase64, fileName };
}
async function downloadPDF(){
  const formEl = document.getElementById('service-form');
  if (!formEl.reportValidity()){ alert('請確認所有必填欄位均已填寫'); return; }
  const data = collectFormData();
  const sigs = collectSignatures();
  const { worker } = await createPdf(data, sigs);
  await worker.save();   // 直接存檔
}
window.downloadPDF = downloadPDF;

/* =============== 傳後端（避免 Preflight，附備援） =============== */
async function postToWebApp(payload){
  // 1) 純字串（text/plain）
  try{
    const r1 = await fetch(WEBAPP_URL, { method:'POST', body: JSON.stringify(payload) });
    const t1 = await r1.text();
    try { return { ok:true, data: JSON.parse(t1) }; }
    catch { return { ok:true, data:null, raw:t1 }; }
  }catch(e1){}

  // 2) FormData
  try{
    const fd = new FormData();
    fd.append('data', JSON.stringify(payload));
    const r2 = await fetch(WEBAPP_URL, { method:'POST', body: fd });
    const t2 = await r2.text();
    try { return { ok:true, data: JSON.parse(t2) }; }
    catch { return { ok:true, data:null, raw:t2 }; }
  }catch(e2){}

  // 3) no-cors（一定送得出去，但讀不到回應）
  try{
    await fetch(WEBAPP_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(payload) });
    return { ok:true, opaque:true };
  }catch(e3){ return { ok:false, error:'Failed to fetch（三種方式都失敗）' }; }
}

/* =============== 發送：寫回表單/存雲端/寄信 =============== */
async function submitForm(){
  const formEl = document.getElementById('service-form');
  if (!formEl.reportValidity()){ alert('請確認所有必填欄位均已填寫'); return; }

  const formData   = collectFormData();
  const signatures = collectSignatures();
  const { pdfBase64, fileName } = await createPdf(formData, signatures);

  const payload = {
    form: formData,
    signatures,
    pdfBase64,
    filename: fileName,
    sendTo: (document.getElementById('sendTo')?.value || '').trim(),
    sendEmail: !!(document.getElementById('sendTo')?.value || '').trim()
  };

  const res = await postToWebApp(payload);
  if (!res.ok){ alert(res.error || '發送失敗'); return; }

  if (res.data?.ok || res.data?.result === 'ok') {
    alert('發送成功！' + (res.data.pdfUrl ? ('\nPDF 連結：' + res.data.pdfUrl) : ''));
  } else if (res.opaque) {
    alert('已送出（跨網域限制無法讀回伺服器回覆）。\n請到試算表與雲端資料夾確認，或查看通知信。');
  } else {
    alert('送出完成，但回應無法解析。');
  }
}
window.submitForm = submitForm;

/* 啟動 */
window.addEventListener('load', initPads);
</script>
</body>
</html>
