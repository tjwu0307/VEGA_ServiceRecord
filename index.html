<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>服務記錄表填寫</title>
  <!-- 使用 html2pdf 與 SignaturePad 來源 -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <style>
    body {
      font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      margin: 0;
      padding: 0;
      background: #fff;
      color: #111;
    }
    /* 表單容器寬度與背景 */
    #service-form {
      width: 190mm;
      max-width: 100%;
      margin: 0 auto;
      padding: 10mm;
      box-sizing: border-box;
      background: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-bottom: 10px;
    }
    th, td {
      border: 1px solid #999;
      padding: 4px;
      vertical-align: top;
      word-break: break-word;
    }
    th {
      background: #f1f1f1;
      text-align: left;
      white-space: nowrap;
    }
    input[type="text"], input[type="number"], textarea {
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
      padding: 2px;
      border: 1px solid #ccc;
    }
    textarea {
      resize: vertical;
    }
    .signature-box {
      border: 1px solid #000;
      height: 100px;
    }
    .actions {
      margin-top: 10px;
      text-align: center;
    }
    .btn {
      border: 1px solid #444;
      background: #FF5151;
      color: #fff;
      padding: 6px 20px;
      font-size: 14px;
      cursor: pointer;
      margin: 0 10px;
    }
    .btn:hover {
      background: #e04848;
    }
    /* 隱藏用於填充 PDF 的容器 */
    #pdf-container {
      display: none;
    }
  </style>
</head>
<body>
  <form id="service-form">
    <h2 style="text-align:center; margin-top:0">服務記錄表</h2>
    <table>
      <tr>
        <th>專案代號</th>
        <td><input id="projectCode" type="text" required></td>
        <th>叫修單號</th>
        <td><input id="ticketNo" type="text" required></td>
      </tr>
      <tr>
        <th>客戶名稱</th>
        <td colspan="3"><input id="customerName" type="text" required></td>
      </tr>
      <tr>
        <th>地址</th>
        <td colspan="3"><input id="address" type="text" required></td>
      </tr>
      <tr>
        <th>聯絡人</th>
        <td><input id="contact" type="text" required></td>
        <th>電話</th>
        <td><input id="phone" type="text" required></td>
      </tr>
      <tr>
        <th>服務日期（民國）</th>
        <td colspan="3">
          <input id="roc_y" type="number" placeholder="年" style="width:50px" required> 年
          <input id="roc_m" type="number" placeholder="月" style="width:30px" required> 月
          <input id="roc_d" type="number" placeholder="日" style="width:30px" required> 日
        </td>
      </tr>
      <tr>
        <th>到達時間</th>
        <td><input id="arriveTxt" type="time" required></td>
        <th>結束時間</th>
        <td><input id="finishTxt" type="time" required></td>
      </tr>
      <tr>
        <th>服務方式</th>
        <td colspan="3">
          <div id="service-methods" style="display:grid;grid-template-columns:repeat(3,1fr);gap:4px;">
            <label><input type="checkbox" name="serviceMethod" value="場勘"> 場勘</label>
            <label><input type="checkbox" name="serviceMethod" value="客戶需求討論"> 客戶需求討論</label>
            <label><input type="checkbox" name="serviceMethod" value="POC"> POC</label>
            <label><input type="checkbox" name="serviceMethod" value="教育訓練"> 教育訓練</label>
            <label><input type="checkbox" name="serviceMethod" value="DEMO 產品展示"> DEMO 產品展示</label>
            <label><input type="checkbox" name="serviceMethod" value="交貨"> 交貨</label>
            <label><input type="checkbox" name="serviceMethod" value="安裝"> 安裝</label>
            <label><input type="checkbox" name="serviceMethod" value="驗收"> 驗收</label>
            <label><input type="checkbox" name="serviceMethod" value="維修"> 維修</label>
            <label><input type="checkbox" name="serviceMethod" value="移機服務"> 移機服務</label>
            <label><input type="checkbox" name="serviceMethod" value="會議支援"> 會議支援</label>
            <label style="grid-column:span 3;">其他：<input id="otherService" type="text"></label>
          </div>
        </td>
      </tr>
      <tr>
        <th>服務產品</th>
        <td colspan="3">
          <table style="width:100%;border-collapse:collapse">
            <tr><th>廠牌</th><th>型號</th><th>版本</th><th>序號</th></tr>
            <tr>
              <td><input id="brand1" type="text"></td>
              <td><input id="model1" type="text"></td>
              <td><input id="version1" type="text"></td>
              <td><input id="serial1" type="text"></td>
            </tr>
            <tr>
              <td><input id="brand2" type="text"></td>
              <td><input id="model2" type="text"></td>
              <td><input id="version2" type="text"></td>
              <td><input id="serial2" type="text"></td>
            </tr>
            <tr>
              <td><input id="brand3" type="text"></td>
              <td><input id="model3" type="text"></td>
              <td><input id="version3" type="text"></td>
              <td><input id="serial3" type="text"></td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <th>服務內容</th>
        <td colspan="3"><textarea id="serviceContent" rows="4" required></textarea></td>
      </tr>
      <tr>
        <th>客戶意見</th>
        <td colspan="3"><textarea id="customerFeedback" rows="3"></textarea></td>
      </tr>
      <tr>
        <th>直屬主管簽名</th>
        <td><canvas id="sig-manager" class="signature-box" width="250" height="100"></canvas><br><button type="button" onclick="clearSignature('manager')">清除</button></td>
        <th>工程師簽名</th>
        <td><canvas id="sig-engineer" class="signature-box" width="250" height="100"></canvas><br><button type="button" onclick="clearSignature('engineer')">清除</button></td>
      </tr>
      <tr>
        <th>客戶簽名</th>
        <td><canvas id="sig-customer" class="signature-box" width="250" height="100"></canvas><br><button type="button" onclick="clearSignature('customer')">清除</button></td>
        <th>工程師姓名</th>
        <td><input id="engineer" type="text"></td>
      </tr>
      <tr>
        <th>寄送 Email (可選)</th>
        <td colspan="3"><input id="sendTo" type="email" placeholder="收件者 Email (若不寄送請留空)"></td>
      </tr>
    </table>
    <div class="actions">
      <button type="button" class="btn" onclick="downloadPDF()">列印 / PDF</button>
      <button type="button" class="btn" onclick="submitForm()">發送 (Email/雲端)</button>
    </div>
  </form>
  <!-- 隱藏容器供產生 PDF 用 -->
  <div id="pdf-container"></div>
  <script>
    // 設定您的 Apps Script 部署網址
    const WEBAPP_URL = '';

    // 初始化簽名板
    const pads = {};
    window.onload = () => {
      pads.manager = new SignaturePad(document.getElementById('sig-manager'));
      pads.engineer = new SignaturePad(document.getElementById('sig-engineer'));
      pads.customer = new SignaturePad(document.getElementById('sig-customer'));
      // 預設時間
      const now = new Date();
      document.getElementById('roc_y').value = now.getFullYear() - 1911;
      document.getElementById('roc_m').value = String(now.getMonth() + 1).padStart(2,'0');
      document.getElementById('roc_d').value = String(now.getDate()).padStart(2,'0');
    };

    function clearSignature(type) {
      pads[type].clear();
    }

    // 收集服務方式
    function collectServiceMethods() {
      const selected = Array.from(document.querySelectorAll('input[name="serviceMethod"]:checked')).map(cb => cb.value);
      const other = document.getElementById('otherService').value.trim();
      if (other) selected.push(other);
      return selected;
    }

    // 收集產品資料，串為字串
    function collectProducts() {
      const products = [];
      for (let i = 1; i <= 3; i++) {
        const brand = document.getElementById('brand' + i).value.trim();
        const model = document.getElementById('model' + i).value.trim();
        const version = document.getElementById('version' + i).value.trim();
        const serial = document.getElementById('serial' + i).value.trim();
        if (brand || model || version || serial) {
          products.push(`${brand}/${model}/${version}/${serial}`);
        }
      }
      return products.join('\n');
    }

    // 收集表單資料
    function collectFormData() {
      return {
        projectCode: document.getElementById('projectCode').value.trim(),
        ticketNo: document.getElementById('ticketNo').value.trim(),
        customerName: document.getElementById('customerName').value.trim(),
        address: document.getElementById('address').value.trim(),
        contact: document.getElementById('contact').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        rocY: document.getElementById('roc_y').value.trim(),
        rocM: document.getElementById('roc_m').value.trim(),
        rocD: document.getElementById('roc_d').value.trim(),
        arriveTxt: document.getElementById('arriveTxt').value.trim(),
        finishTxt: document.getElementById('finishTxt').value.trim(),
        serviceMethods: collectServiceMethods(),
        products: collectProducts(),
        serviceContent: document.getElementById('serviceContent').value.trim(),
        customerFeedback: document.getElementById('customerFeedback').value.trim(),
        engineer: document.getElementById('engineer').value.trim()
      };
    }

    // 將簽名轉為 DataURL
    function collectSignatures() {
      return {
        manager: pads.manager && !pads.manager.isEmpty() ? pads.manager.toDataURL() : '',
        engineer: pads.engineer && !pads.engineer.isEmpty() ? pads.engineer.toDataURL() : '',
        customer: pads.customer && !pads.customer.isEmpty() ? pads.customer.toDataURL() : ''
      };
    }

    // PDF 範本，使用 mustache 樣式占位符
    const pdfTemplate = `
      <style>
        body { font-family: 'Noto Sans TC', sans-serif; font-size: 12px; margin: 0; padding: 0; }
        table { width: 100%; border-collapse: collapse; }
        td, th { border: 1px solid #000; padding: 4px; vertical-align: top; }
        th { background: #f5f5f5; }
      </style>
      <h2 style="text-align:center;">服務記錄表</h2>
      <table>
        <tr><th>專案代號</th><td>{{projectCode}}</td><th>叫修單號</th><td>{{ticketNo}}</td></tr>
        <tr><th>客戶名稱</th><td>{{customerName}}</td><th>地址</th><td>{{address}}</td></tr>
        <tr><th>聯絡人</th><td>{{contact}}</td><th>電話</th><td>{{phone}}</td></tr>
        <tr><th colspan="1">服務日期</th><td colspan="3">民國{{rocY}}年{{rocM}}月{{rocD}}日&nbsp;&nbsp;到達：{{arriveTxt}}&nbsp;&nbsp;結束：{{finishTxt}}</td></tr>
        <tr><th>服務方式</th><td colspan="3">{{serviceMethods}}</td></tr>
        <tr><th>服務產品</th><td colspan="3">{{products}}</td></tr>
        <tr><th>服務內容</th><td colspan="3">{{serviceContent}}</td></tr>
        <tr><th>客戶意見</th><td colspan="3">{{customerFeedback}}</td></tr>
        <tr>
          <th>直屬主管簽名</th><td><img src="{{sign_manager}}" style="height:80px;"></td>
          <th>工程師簽名</th><td><img src="{{sign_engineer}}" style="height:80px;"></td>
        </tr>
        <tr>
          <th>客戶簽名</th><td><img src="{{sign_customer}}" style="height:80px;"></td>
          <th>工程師姓名</th><td>{{engineer}}</td>
        </tr>
      </table>`;

    // 將範本填入資料
    function fillTemplate(template, data) {
      let result = template;
      const mapping = {
        projectCode: data.projectCode,
        ticketNo: data.ticketNo,
        customerName: data.customerName,
        address: data.address,
        contact: data.contact,
        phone: data.phone,
        rocY: data.rocY,
        rocM: data.rocM,
        rocD: data.rocD,
        arriveTxt: data.arriveTxt,
        finishTxt: data.finishTxt,
        serviceMethods: Array.isArray(data.serviceMethods) ? data.serviceMethods.join('、') : data.serviceMethods,
        products: data.products,
        serviceContent: data.serviceContent,
        customerFeedback: data.customerFeedback,
        sign_manager: data.sign_manager || '',
        sign_engineer: data.sign_engineer || '',
        sign_customer: data.sign_customer || '',
        engineer: data.engineer || ''
      };
      Object.keys(mapping).forEach(key => {
        const regex = new RegExp('{{' + key + '}}', 'g');
        result = result.replace(regex, mapping[key]);
      });
      return result;
    }

    // 產生 PDF base64 並返回 {pdfBase64, fileName}
    async function createPdf(formData, signatures) {
      // 將簽名加入 formData 以供範本替換
      const pdfData = Object.assign({}, formData, {
        sign_manager: signatures.manager,
        sign_engineer: signatures.engineer,
        sign_customer: signatures.customer
      });
      const html = fillTemplate(pdfTemplate, pdfData);
      // 使用 html2pdf 直接從 HTML 字串產生 PDF。必須指定 type: 'string'。
      const opt = {
        margin: 10,
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      // Worker API: 從 HTML 字串生成 PDF 並輸出為 base64 data uri
      const worker = html2pdf().set(opt).from(html, 'string');
      const pdfBase64 = await worker.outputPdf('datauristring');
      // 檔名：服務記錄_客戶名稱_yyyymmdd.pdf
      const dateStr = formData.rocY + formData.rocM + formData.rocD;
      const safeName = formData.customerName.replace(/\s+/g, '') || '未命名';
      const fileName = `服務記錄_${safeName}_${dateStr}.pdf`;
      return { pdfBase64, fileName };
    }

    // 按「列印 / PDF」產生本地 PDF 下載
    async function downloadPDF() {
      const form = document.getElementById('service-form');
      if (!form.reportValidity()) {
        alert('請確認所有必填欄位均已填寫');
        return;
      }
      const formData = collectFormData();
      const signatures = collectSignatures();
      const { pdfBase64, fileName } = await createPdf(formData, signatures);
      // 利用 html2pdf 另存本地檔案
      const link = document.createElement('a');
      link.href = pdfBase64;
      link.download = fileName;
      link.click();
    }
    window.downloadPDF = downloadPDF;

    // 按「發送」提交表單、存入試算表、存檔並寄送
    async function submitForm() {
      const form = document.getElementById('service-form');
      if (!form.reportValidity()) {
        alert('請確認所有必填欄位均已填寫');
        return;
      }
      const formData = collectFormData();
      const signatures = collectSignatures();
      const { pdfBase64, fileName } = await createPdf(formData, signatures);
      // 組成 payload
      const payload = {
        data: formData,
        signatures: signatures,
        pdfBase64: pdfBase64,
        filename: fileName,
        sendTo: document.getElementById('sendTo').value.trim() || ''
      };
      try {
        const res = await fetch(WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (result && result.result === 'ok') {
          alert('發送成功！');
        } else {
          alert('發送失敗。');
        }
      } catch (err) {
        console.error(err);
        alert('發送過程中發生錯誤：' + err.message);
      }
    }
    window.submitForm = submitForm;
  </script>
</body>
</html>
