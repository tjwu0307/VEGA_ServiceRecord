<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>VEGA 服務記錄表</title>

<!-- 外掛：先載入（順序不能換） -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<style>
  /* ====== 版面：不動你的表格，僅覆寫修正 ====== */
  body{font-family:"Noto Sans TC","Microsoft JhengHei",sans-serif;margin:0;background:#fff;color:#111}
  #service-form{width: 190mm; max-width:800px; margin:10mm auto; padding:0 4mm}
  .no-pdf{display:inline-block}
  @media print{ body {
    margin: 0;
    padding: 0;
  }

  .form-wrapper {
    width: 210mm;
    padding: 0mm;
    margin: auto;
    box-sizing: border-box;
  }

  input, textarea {
    max-width: 100%;
  }
}

  table.form{width:800px; border-collapse:collapse; table-layout:auto !important}
  table.form th, table.form td{border:1px solid #888; padding:6px; vertical-align:middle; font-size:12px}
  table.form th{background:#f7f7f7; text-align:left; white-space:nowrap}

  /* 公司抬頭 */
.header-wrap {
  display: flex;
  gap: 12px;
  align-items: flex-start;
  margin: 8px 0 6px;
}
.header-wrap img {
  height: 60px;
}
.company-info {
  display: flex;
  gap: 32px;
  line-height: 1.35;
}
.company-info .branch {
  font-size: 12px;
}

  /* 欄位輸入填滿格子、保留表格線條 */
  input[type="text"], input[type="number"], input[type="email"], select, textarea{
    width:100%; box-sizing:border-box; border:0; background:transparent; font:inherit; line-height:1.3
  }
  textarea{resize:vertical}

  /* 日期/時間不直排斷行（輸出 PDF 時也會套 .nowrap） */
  .nowrap{ white-space:nowrap !important; }

  /* 服務方式 checkbox 行內排列 */
  .chkrow label{ margin-right:14px; white-space:nowrap; }

  /* 服務產品表內欄位 */
  .subtable{width:100%; border-collapse:collapse}
  .subtable th, .subtable td{border:1px solid #aaa; padding:4px; font-size:12px}

  /* 簽名區：固定高度、避免被切頁 */
.sig-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.sig-box {
  width: 100%;
  height: 80px;
  border: 1px solid #ccc;
  background-color: #fff;
}
  .sig-clear{margin-top:6px}
  .sig-cell {
  width: 33.333%;
  text-align: center;
  vertical-align: top;
}


  /* 列印/轉PDF避免拆行 */
  table, tr, th, td{ page-break-inside:avoid !important; }
  /* 內層簽名表：三等分滿版 */
.sig-table{ width:100%; border-collapse:collapse; table-layout:fixed; }
.sig-table th, .sig-table td{ width:33.333%; padding:6px; vertical-align:top; }

/* 簽名區塊保持高度、按鈕在下方 */

.sig-box canvas{ width:100%; height:100%; display:block; }
.sig-clear{ align-self:flex-end; }
.page {
 width: 190mm;
  margin: 0 auto;
  padding: 10mm;
  page-break-after: always;
  font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
  font-size: 14px;
  line-height: 1.6;
}
  .page h2 {
  font-size: 16px;
  margin-bottom: 8px;
  font-weight: bold;
}
  .page p {
  margin: 4px 0;
}
.form-wrapper {
   width: 190mm; /* A4 寬度 */
  max-width: 100%;
  margin: 0 auto;
  box-sizing: border-box;
  padding: 10mm;
}
  table {
  width: 100%;
  table-layout: fixed;
}

td:first-child {
  width: 140px; /* 左側標籤欄寬度 */
}
td:last-child {
  width: auto;
}
  html2pdf().set({
  margin: 0,
  filename: 'VEGA_ServiceRecord.pdf',
  image: { type: 'jpeg', quality: 0.98 },
  html2canvas: { scale: 2 },
  jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
}).from(document.getElementById('form-wrapper')).save();
table.form input[type="text"],
table.form input[type="number"],
table.form textarea {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
}
  table.form th {
  text-align: center;
}
canvas {
  width: 100%;
  max-width: 100%;
}
.main-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}
.main-table th,
.main-table td {
  border: 1px solid #000;
  padding: 4px;
}
.main-table th[colspan],
.main-table td[colspan] {
  /* 保證等分，8 欄就每格 = 12.5% */
}
  .product-cell {
  min-height: 1.2em;   /* 至少一行文字高 */
  line-height: 1.2em;  /* 保持行高 */
  height: 20px;        /* 可視需求設定固定高度 */
}
</style>
</head>
<body>

<form id="service-form">
  <div id="pdf-content">
<!-- 公司抬頭區塊 -->
<div class="header-wrap">
  <!-- 左側 LOGO -->
  <div>
    <img src="logo.png" alt="VEGA Logo" style="height: 80px;">
  </div>

  <!-- 右側 公司名稱 + 三區資訊 -->
  <div style="display: flex; flex-direction: column;">
    <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 6px;">
      維嘉全球科技股份有限公司
    </div>

    <!-- 三區資訊 -->
    <div style="display: flex; gap: 24px; font-size: 0.85em;">
      <div style="flex: 1; min-width: 0;">
        <strong>北區</strong><br>
        台北市內湖區東湖路129號14F-1<br>
        免付費專線: 0800-521-800<br>
        Tel: (02)3518-2888<br>
        Fax: (02)2545-1155
      </div>
      <div style="flex: 1; min-width: 0;">
        <strong>中區</strong><br>
        台中市北區文心路四段81號8樓之2<br>
        Tel: (04)2295-8966<br>
        Fax: (04)2295-5833
      </div>
      <div style="flex: 1; min-width: 0;">
        <strong>南區</strong><br>
        高雄市新興區中山二路91號8樓之9<br>
        Tel: (07)335-0099<br>
        Fax: (07)535-0099
      </div>
    </div>
  </div>
</div>

    <!-- 你的表格（欄位與排列保持） -->
   <table class="main-table">
      <tr>
      <th>專案代號</th>
      <td><input id="projectCode" type="text"></td>
      <th>叫修單號</th>
      <td><input id="ticketNo" type="text"></td>
      <th colspan="2" style="font-size:18px;text-align:center">服務記錄表</th>
      <th>CRM 安裝單號</th>
      <td><input id="crm_install" type="text"></td>
      <th>CRM 維修單號</th>
      <td><input id="crm_install" type="text"></td>
    </tr>
      <tr>
      <th>客戶名稱</th>
      <td colspan="5"><input id="customerName" type="text"></td>
      <th>連絡人</th>
      <td><input id="crm_repair" type="text"></td>
    </tr>
 <tr>
      <th>地址</th>
      <td colspan="5"><input id="address" type="text"></td>
      <th>電話</th>
      <td><input id="contact" type="text"></td>
    </tr>
      <tr>
        <th colspan="1">服務日期（民國）</th>
        <td colspan="3">
           <span style="display: inline-block;text-align: center;">
    <input id="roc_y" type="number" placeholder="___" style="width: 60px;"> 年
  </span>
  <span style="display: inline-block;">
    <input id="roc_m" type="number" placeholder="__" style="width: 40px;"> 月
  </span>
  <span style="display: inline-block;">
    <input id="roc_d" type="number" placeholder="__" style="width: 40px;"> 日
  </span>
        </td>
        <th colspan="1">到達時間</th>
        <td colspan="1"><input id="arriveTxt" class="nowrap" type="text" placeholder="__:__" style="text-align: center;"></td>
        <th colspan="1">結束時間</th>
        <td colspan="1"><input id="finishTxt" class="nowrap" type="text" placeholder="__:__" style="text-align: center;"></td>      
      </tr>

      <tr>
        <th>服務方式</th>
        <td colspan="7" class="chkrow">
          <label><input type="checkbox" name="serviceMethod" value="場勘"> 場勘</label>
          <label><input type="checkbox" name="serviceMethod" value="POC"> POC</label>
          <label><input type="checkbox" name="serviceMethod" value="簡報"> 簡報</label>          
          <label><input type="checkbox" name="serviceMethod" value="安裝"> 安裝</label>
          <label><input type="checkbox" name="serviceMethod" value="驗收"> 驗收</label>          
          <label><input type="checkbox" name="serviceMethod" value="檢修"> 檢修</label>
          <label><input type="checkbox" name="serviceMethod" value="交貨"> 交貨</label>
          <label><input type="checkbox" name="serviceMethod" value="教育訓練"> 教育訓練</label>
          <label><input type="checkbox" name="serviceMethod" value="客戶需求訪談"> 客戶需求訪談</label>
          <label><input type="checkbox" name="serviceMethod" value="DEMO 產品展示"> DEMO 產品展示</label>
          <label><input type="checkbox" name="serviceMethod" value="移機服務"> 移機服務</label>    
          <label><input type="checkbox" name="serviceMethod" value="會議支援"> 會議支援</label>
          <span style="margin-left:10px">其他：<input id="serviceOther" type="text" name="other" style="width:220px"></span>
        </td>
      </tr>

      <tr>
        <th>服務產品</th>
        <td colspan="7" style="padding:0">
          <table class="product-table" class="subtable">
            <tr><th style="width:15%;text-align: center;">廠牌</th><th style="width:25%;text-align: center;">型號</th><th style="width:15%;text-align: center;">版本</th><th style="width:45%;text-align: center;">序號</th></tr>
            <tr>
              <td class="product-cell"><input name="brand[]"   type="text"></td>
              <td class="product-cell"><input name="model[]"   type="text"></td>
              <td class="product-cell"><input name="version[]" type="text"></td>
              <td class="product-cell"><input name="serial[]"  type="text"></td>
            </tr>
            <tr>
              <td class="product-cell"><input name="brand[]"   type="text"></td>
              <td class="product-cell"><input name="model[]"   type="text"></td>
              <td class="product-cell"><input name="version[]" type="text"></td>
              <td class="product-cell"><input name="serial[]"  type="text"></td>
            </tr>
            <tr>
              <td class="product-cell"><input name="brand[]"   type="text"></td>
              <td class="product-cell"><input name="model[]"   type="text"></td>
              <td class="product-cell"><input name="version[]" type="text"></td>
              <td class="product-cell"><input name="serial[]"  type="text"></td>
            </tr>
          </table>
        </td>
      </tr>

      <tr>
        <th>服務內容</th>
        <td colspan="7"><textarea id="serviceContent" rows="4"></textarea></td>
      </tr>
      <tr>
        <th>客戶意見</th>
        <td colspan="7"><textarea id="customerFeedback" rows="3"></textarea></td>
      </tr>
       <!-- 簽名區 -->
  <tr>
  <th colspan="2" class="sig-table">直屬主管簽名</th>
  <th colspan="3" class="sig-table">工程師簽名</th>
  <th colspan="3" class="sig-table">客戶簽名</th>
</tr>
<tr>
  <td  colspan="2"class="sig-cell" >
    <div class="sig-wrap">
      <div class="sig-box"><canvas id="sig-manager"></canvas></div>
      <button type="button" class="no-pdf sig-clear" onclick="clearSignature('manager')">清除</button>
    </div>
  </td>
  <td  colspan="3" class="sig-cell">
    <div class="sig-wrap">
    <div class="sig-wrap">
      <div  class="sig-box"><canvas id="sig-engineer"></canvas></div>
      <button type="button" class="no-pdf sig-clear" onclick="clearSignature('engineer')">清除</button>
    </div>
  </td>
  <td  colspan="3" class="sig-cell" >
    <div class="sig-wrap">
      <div class="sig-box"><canvas id="sig-customer"></canvas></div>
      <button type="button" class="no-pdf sig-clear" onclick="clearSignature('customer')">清除</button>
    </div>
  </td>
</tr>
      <tr>
      <td colspan="8" style="text-align:left;font-weight:bold">費用申請：(以下由工程師攜回單據後填寫申請)</td>
    </tr>
    <tr>
      <td colspan="8">
        <table style="width:100%;border-collapse:collapse">
          <tr>
            <th>里程KM</th>
            <th>出發地點</th>
            <th>計程車資</th>
            <th>停車費</th>
            <th>eTag</th>
            <th>大眾運輸</th>
            <th>其他</th>
          </tr>
          <tr>
            <td><input id="km" type="number" style="height:2em; text-align:center;"></td>
            <td><input id="startPlace" type="text" value="公司" style="height:2em; text-align:center;"></td>
            <td><input id="taxi" type="number" style="height:2em; text-align:center;"></td>
            <td><input id="parking" type="number" style="height:2em; text-align:center;"></td>
            <td><input id="etag" type="number" style="height:2em; text-align:center;"></td>
            <td><input id="publicTrans" type="number" style="height:2em; text-align:center;"></td>
            <td><input id="expenseOther" type="text" style="height:2em; text-align:center;"></td>
          </tr>
  </table> 
 <!-- 三聯用途標示（表格外） -->
<div style="margin-top: 10px; font-size: 0.9em; text-align: right;">
  白聯：工程師部門  紅聯：財務部（請款用） 黃聯：客戶收執     
</div>
     <div class="actions" style="text-align:center; margin:14px 0">
      <button type="button" class="no-pdf" onclick="downloadPDF()" style="padding:6px 18px;background-color: #FF5151; border: none; color: white;">列印 / PDF</button>
      <button type="button" class="no-pdf" onclick="submitForm()"  style="padding:6px 18px;background-color: #FF5151; border: none; color: white;">發送(Email/雲端/寫回)</button>
    </div>
  </div>
 <div class="no-pdf">寄送 Email（可選）：<input id="sendTo" type="email" placeholder="收件者 Email（若不寄送可留空）"></div>
</form>
<script>
/* ======= 設定（換成你最新的 Web App /exec） ======= */
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbya6vjHvFLLFUc4Ct4xCuoO1V9LTQVsXFZ1Z4GXcR2eCYh0DrjvSBuozhSNxslAiv2thw/exec';


/* ======= 簽名板 ======= */
let pads = {};
function fitCanvas(c){
  const ratio = Math.max(window.devicePixelRatio||1,1);
  const rect = c.getBoundingClientRect();
  c.width  = Math.round(rect.width * ratio);
  c.height = Math.round(rect.height * ratio);
  c.getContext('2d').scale(ratio, ratio);
}
function initPads(){
  ['manager','engineer','customer'].forEach(id=>{
    const c = document.getElementById('sig-'+id);
    fitCanvas(c);
    pads[id] = new SignaturePad(c, {backgroundColor:'rgba(255,255,255,0)'});
  });
}
window.addEventListener('resize', ()=>{
  Object.entries(pads).forEach(([id,p])=>{
    const c = document.getElementById('sig-'+id);
    const data = p.toData(); fitCanvas(c); p.clear(); p.fromData(data);
  });
});
function clearSignature(who){ if(pads[who]) pads[who].clear(); }
window.clearSignature = clearSignature;

/* ======= 資料蒐集 ======= */
function getServiceMethods(){
  return Array.from(document.querySelectorAll('input[name="serviceMethod"]:checked')).map(el=>el.value);
}
function getProducts(){
  const rows = [];
  const brands  = document.getElementsByName('brand[]');
  const models  = document.getElementsByName('model[]');
  const vers    = document.getElementsByName('version[]');
  const serials = document.getElementsByName('serial[]');
  for(let i=0;i<brands.length;i++){
    const b=(brands[i].value||'').trim(), m=(models[i].value||'').trim(),
          v=(vers[i].value||'').trim(), s=(serials[i].value||'').trim();
    if(b||m||v||s) rows.push(`${b}/${m}/${v}/${s}`);
  }
  return rows.join('\n');
}
function getSignatures(){
  return {
    manager:  (pads.manager  && !pads.manager.isEmpty())  ? pads.manager.toDataURL()  : '',
    engineer: (pads.engineer && !pads.engineer.isEmpty()) ? pads.engineer.toDataURL() : '',
    customer: (pads.customer && !pads.customer.isEmpty()) ? pads.customer.toDataURL() : ''
  };
}

/* ======= 只在有簽名時塞 <img>，避免 html2canvas 讀「空 src」 ======= */
function putSignatureImg(root, canvasId, dataUrl){
  const c = root.querySelector('#'+canvasId);
  if(!c) return;
  const holder = c.parentElement;
  holder.innerHTML = '';
  if(dataUrl && /^data:image\//.test(dataUrl)){
    const img = new Image();
    img.src = dataUrl; img.style.maxWidth='100%'; img.style.height='120px';
    holder.appendChild(img);
  }else{
    const box=document.createElement('div'); box.style.height='120px'; holder.appendChild(box);
  }
}

/* ======= 產 PDF 用的乾淨快照（不動畫面、保版面） ======= */
function buildPrintableNode(){
  const src   = document.getElementById('pdf-content');
  const clone = src.cloneNode(true);

  // 去掉按鈕
  clone.querySelectorAll('.no-pdf, button').forEach(n=>n.remove());

  // input/textarea 轉成純文字（避免輸出控制項而空白）
  clone.querySelectorAll('input, textarea, select').forEach(el=>{
    const span = document.createElement('span');
    if(el.type==='checkbox'){ span.textContent = el.checked ? ('■ '+(el.value||'')) : ''; }
    else{ span.textContent = el.value || ''; }
    if(['roc_y','roc_m','roc_d','arriveTxt','finishTxt'].includes(el.id)) span.className='nowrap';
    el.replaceWith(span);
  });

  // 簽名
  const sigs = getSignatures();
  putSignatureImg(clone, 'sig-manager',  sigs.manager);
  putSignatureImg(clone, 'sig-engineer', sigs.engineer);
  putSignatureImg(clone, 'sig-customer', sigs.customer);

  return clone;
}

/* ======= 產 PDF（下載/上傳共用） ======= */
async function createPdf(form){
  const node = buildPrintableNode();
  const fileName = `服務記錄_${form.customerName||''}_${form.rocY||''}${form.rocM||''}${form.rocD||''}.pdf`;
  const opt = {
    margin:10,
    filename:fileName,
    image:{type:'jpeg',quality:0.95},
    html2canvas:{scale:2,useCORS:true,backgroundColor:'#fff',letterRendering:true},
    jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
  };
  const worker = html2pdf().set(opt).from(node);
  const pdf64  = await html2pdf().set(opt).from(node).outputPdf('datauristring');
  return { worker, pdf64, fileName };
}

/* ======= 列印 / PDF ======= */
async function downloadPDF(){
  const f=document.getElementById('service-form');
  if(!f.reportValidity()){ alert('請確認所有必填欄位均已填寫'); return; }
  const form = collectForm();
  const { worker } = await createPdf(form);
  await worker.save();
}

/* ======= 組表單資料 ======= */
function collectForm(){
  const g=id=>document.getElementById(id)?.value?.trim()||'';
  return {
    timestamp:new Date(),
    projectCode:g('projectCode'),
    ticketNo:g('ticketNo'),
    crm_install:g('crm_install'),
    crm_repair:g('crm_repair'),
    customerName:g('customerName'),
    address:g('address'),
    contact:g('contact'),
    phone:g('phone'),
    engineer:g('engineer'),
    rocY:g('roc_y'), rocM:g('roc_m'), rocD:g('roc_d'),
    arriveTxt:g('arriveTxt'), finishTxt:g('finishTxt'),
    serviceMethods:getServiceMethods(),
    products:getProducts(),
    serviceContent:g('serviceContent'),
    customerFeedback:g('customerFeedback'),
    serviceOther:g('serviceOther')
  };
}

/* ======= 傳到 GAS：避免預檢 + 備援 ======= */
async function postToWebApp(payload){
  try{
    const r1=await fetch(WEBAPP_URL,{method:'POST',body:JSON.stringify(payload)});
    const t1=await r1.text(); try{return{ok:true,data:JSON.parse(t1)}}catch{return{ok:true,data:null,raw:t1}}
  }catch(e1){}
  try{
    const fd=new FormData(); fd.append('data',JSON.stringify(payload));
    const r2=await fetch(WEBAPP_URL,{method:'POST',body:fd});
    const t2=await r2.text(); try{return{ok:true,data:JSON.parse(t2)}}catch{return{ok:true,data:null,raw:t2}}
  }catch(e2){}
  try{
    await fetch(WEBAPP_URL,{method:'POST',mode:'no-cors',body:JSON.stringify(payload)});
    return {ok:true,opaque:true};
  }catch(e3){ return {ok:false,error:'Failed to fetch（三種方式都失敗）'}; }
}

/* ======= 發送（寫回表、存雲端、可寄信） ======= */
async function submitForm(){
  const f=document.getElementById('service-form');
  if(!f.reportValidity()){ alert('請確認所有必填欄位均已填寫'); return; }

  const form = collectForm();
  const sigs = getSignatures();
  const { pdf64, fileName } = await createPdf(form);

  const payload = {
    form, signatures: sigs, pdfBase64: pdf64, filename: fileName,
    sendTo: (document.getElementById('sendTo')?.value||'').trim(),
    sendEmail: !!(document.getElementById('sendTo')?.value||'').trim()
  };

  const res = await postToWebApp(payload);
  if(!res.ok){ alert(res.error || '發送失敗'); return; }
  if(res.data?.ok || res.data?.result==='ok'){
    alert('發送成功！' + (res.data.pdfUrl?('\nPDF：'+res.data.pdfUrl):''));
  }else if(res.opaque){
    alert('已送出（跨網域限制無法讀回回覆）。\n請到試算表與雲端資料夾確認，或查看通知信。');
  }else{
    alert('送出完成，但回應無法解析。');
  }
}

/* 掛全域與初始化 */
window.downloadPDF = downloadPDF;
window.submitForm  = submitForm;
window.addEventListener('load', initPads);
</script>
</body>
</html>








